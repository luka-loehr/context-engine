# Contributing to Context Engine

Thank you for your interest in contributing to Context Engine! This guide will help you extend the system with new tools, subagents, providers, and more.

## üéØ Quick Start

### For Beginners
1. **Add a Tool**: Easiest way to contribute (15 minutes)
2. **Create a SubAgent**: Generate custom documentation (1 hour)
3. **Add a Provider**: Integrate new AI models (3 hours)

### For Experts
1. **Refactor Core**: Improve architecture
2. **Add Features**: New command systems
3. **Optimize Performance**: Speed and efficiency

## üìã Table of Contents

- [Setting Up Development Environment](#setting-up-development-environment)
- [Adding a Tool](#adding-a-tool)
- [Creating a SubAgent](#creating-a-subagent)
- [Adding an AI Provider](#adding-an-ai-provider)
- [Code Style Guide](#code-style-guide)
- [Testing Guidelines](#testing-guidelines)
- [Documentation Requirements](#documentation-requirements)
- [Pull Request Process](#pull-request-process)

## üîß Setting Up Development Environment

### Prerequisites
- Node.js >= 16.0.0
- npm or yarn
- Git
- API key for testing (XAI Grok or OpenAI)

### Clone and Setup

```bash
# Clone repository
git clone https://github.com/luka-loehr/context-engine.git
cd context-engine

# Install dependencies
npm install

# Create .env file
cat > .env << EOF
XAI_API_KEY=your_xai_api_key_here
# or
OPENAI_API_KEY=your_openai_api_key_here
EOF

# Link for local testing
npm link

# Test installation
context --version
```

### Development Workflow

```bash
# Make changes
# ...

# Test locally
npm uninstall -g @lukaloehr/context-engine
npm install -g .

# Run context-engine
cd ~/your-test-project
context

# Unlink when done
npm unlink -g @lukaloehr/context-engine
```

## üî® Adding a Tool

Tools are functions that AI can call. They're the easiest way to extend Context Engine.

### Step 1: Define Your Tool

Edit `src/tools/definitions.js` and add:

```javascript
toolRegistry.register({
  name: 'analyzeImports',
  description: 'Analyze import statements in a JavaScript/TypeScript file and identify unused imports.',
  parameters: {
    type: 'object',
    properties: {
      filePath: {
        type: 'string',
        description: 'Path to the JS/TS file to analyze'
      }
    },
    required: ['filePath']
  },
  availableTo: ToolCategories.SHARED, // or MAIN, or SUBAGENT
  tags: ['analysis', 'code', 'imports'],
  handler: async (parameters, context) => {
    const { filePath } = parameters;
    const { projectContext } = context;
    
    // Find file
    const file = projectContext.find(f => f.path === filePath);
    if (!file) {
      return {
        success: false,
        error: `File not found: ${filePath}`
      };
    }
    
    // Analyze imports
    const imports = extractImports(file.content);
    const unused = findUnusedImports(file.content, imports);
    
    return {
      success: true,
      imports,
      unused,
      count: {
        total: imports.length,
        unused: unused.length
      }
    };
  }
});

// Helper functions
function extractImports(content) {
  const importRegex = /import\s+.*?\s+from\s+['"](.+?)['"]/g;
  const matches = [];
  let match;
  while ((match = importRegex.exec(content)) !== null) {
    matches.push(match[1]);
  }
  return matches;
}

function findUnusedImports(content, imports) {
  // Your logic here
  return [];
}
```

### Step 2: Test Your Tool

```bash
# Reinstall
npm uninstall -g @lukaloehr/context-engine
npm install -g .

# Test in a project
cd ~/test-project
context

# In chat:
> analyze imports in src/index.js
```

### Step 3: Document Your Tool

Add to tool description:
- What it does
- When to use it
- Example usage
- Return format

### Tool Access Control

| Context | When to Use |
|---------|-------------|
| `MAIN` | User-facing commands, system control |
| `SUBAGENT` | File writing, progress updates |
| `SHARED` | Data access, analysis, both need it |

## ü§ñ Creating a SubAgent

SubAgents are specialized AI assistants for specific documentation tasks.

### Step 1: Create Agent File

Create `src/sub-agents/agents/changelog-md.js`:

```javascript
import { SubAgent } from '../core/base.js';

export class ChangelogSubAgent extends SubAgent {
  constructor() {
    super('CHANGELOG.md', 'Creating CHANGELOG.md');
  }

  getSystemPrompt() {
    return `You are an expert at creating CHANGELOG.md files following Keep a Changelog format.

CHANGELOG.md documents all notable changes to the project organized by version.

IMPORTANT FORMATTING RULES:
- Start with: "# Changelog\\n\\nAll notable changes to this project will be documented in this file."
- Follow [Keep a Changelog](https://keepachangelog.com/en/1.0.0/) format
- Use semantic versioning
- End with footer: "---\\n\\n*Generated by [context-engine](https://github.com/luka-loehr/context-engine)*"

REQUIRED SECTIONS:
## [Unreleased]
- Changes not yet released

## [Version] - YYYY-MM-DD
### Added
- New features

### Changed
- Changes to existing functionality

### Deprecated
- Soon-to-be removed features

### Removed
- Removed features

### Fixed
- Bug fixes

### Security
- Security fixes

WORKFLOW:
Use statusUpdate tool frequently (1-10 words max). When ready, create file with createFile tool including successMessage parameter.

Examine git history, package.json, and recent commits to build comprehensive changelog.`;
  }

  getInitialPrompt() {
    return `Please analyze this codebase's git history and create a comprehensive CHANGELOG.md file.

CRITICAL: Create a properly formatted CHANGELOG.md following Keep a Changelog format.

Examine:
- package.json for version
- Git commit history
- Recent changes
- Breaking changes

Use statusUpdate frequently, then create CHANGELOG.md with successMessage parameter.`;
  }
}

// Export agent configuration for auto-registration
export const agentConfig = {
  name: 'CHANGELOG.md',
  id: 'changelog-md',
  toolName: 'createChangelog',
  description: 'Create a CHANGELOG.md file following Keep a Changelog format. Analyzes git history and package versions to generate comprehensive version history.',
  agentClass: ChangelogSubAgent
};
```

### Step 2: Register Agent

Edit `src/sub-agents/index.js`:

```javascript
import { agentConfig as changelogConfig } from './agents/changelog-md.js';

// Add to registration
registry.register(changelogConfig);
```

### Step 3: Test Your Agent

```bash
npm uninstall -g @lukaloehr/context-engine
npm install -g .
cd ~/test-project
context

# In chat:
> create changelog
# or
> make a changelog.md
```

### Agent Best Practices

‚úÖ **DO:**
- Use clear, specific system prompts
- Call statusUpdate frequently (6+ times)
- Provide helpful successMessage
- Include examples in prompts
- Test with various project types

‚ùå **DON'T:**
- Create overly complex prompts
- Skip statusUpdate calls
- Forget successMessage parameter
- Duplicate content between prompts
- Ignore markdown formatting

## üîå Adding an AI Provider

Providers integrate new AI models (OpenAI, Anthropic, local models, etc.).

### Step 1: Create Provider Class

Create `src/providers/anthropic.js`:

```javascript
import { BaseProvider } from './base.js';
import Anthropic from '@anthropic-ai/sdk';

export class AnthropicProvider extends BaseProvider {
  constructor(apiKey, modelId) {
    super(apiKey);
    this.client = new Anthropic({ apiKey });
    this.modelId = modelId;
  }

  async refinePrompt(messyPrompt, systemPrompt, onChunk, tools, onToolCall) {
    const messages = [
      { role: 'user', content: messyPrompt }
    ];

    let refinedPrompt = '';
    let continueLoop = true;

    while (continueLoop) {
      const params = {
        model: this.modelId,
        max_tokens: 4096,
        system: systemPrompt,
        messages,
        stream: true
      };

      // Add tools if provided
      if (tools?.length > 0) {
        params.tools = tools.map(tool => ({
          name: tool.name,
          description: tool.description,
          input_schema: tool.parameters
        }));
      }

      const stream = await this.client.messages.create(params);

      let currentContent = '';
      let currentToolUse = null;

      for await (const event of stream) {
        if (event.type === 'content_block_delta') {
          if (event.delta.type === 'text_delta') {
            currentContent += event.delta.text;
            if (onChunk) {
              onChunk(event.delta.text);
            }
          } else if (event.delta.type === 'input_json_delta') {
            // Handle tool call
            // (Anthropic-specific implementation)
          }
        }
      }

      // Handle tool calls if present
      if (currentToolUse && onToolCall) {
        const result = await onToolCall(currentToolUse.name, currentToolUse.input);
        
        messages.push({
          role: 'assistant',
          content: [{ type: 'tool_use', ...currentToolUse }]
        });
        
        messages.push({
          role: 'user',
          content: [{
            type: 'tool_result',
            tool_use_id: currentToolUse.id,
            content: JSON.stringify(result)
          }]
        });
        
        continueLoop = !result.stopLoop;
      } else {
        refinedPrompt += currentContent;
        continueLoop = false;
      }
    }

    return refinedPrompt;
  }

  getConfig() {
    return {
      supportsStreaming: true,
      supportsToolCalls: true,
      maxTokens: 200000
    };
  }
}
```

### Step 2: Update Factory

Edit `src/providers/index.js`:

```javascript
import { AnthropicProvider } from './anthropic.js';

export function createProvider(provider, apiKey, modelId) {
  switch (provider) {
    case 'xai':
      return new XAIProvider(apiKey, modelId);
    case 'anthropic':
      return new AnthropicProvider(apiKey, modelId);
    default:
      throw new Error(`Unknown provider: ${provider}`);
  }
}
```

### Step 3: Add Models

Edit `src/constants/models.js`:

```javascript
export const AVAILABLE_MODELS = [
  // Existing models...
  {
    name: 'Claude 3 Opus',
    model: 'claude-3-opus-20240229',
    provider: 'anthropic',
    description: 'Most capable Claude model'
  },
  {
    name: 'Claude 3 Sonnet',
    model: 'claude-3-sonnet-20240229',
    provider: 'anthropic',
    description: 'Balanced performance and speed'
  }
];
```

### Step 4: Update Config Handling

Edit `src/commands/chat.js` to support new provider's API key.

### Step 5: Add Dependencies

```bash
npm install @anthropic-ai/sdk
```

### Step 6: Test Provider

```bash
export ANTHROPIC_API_KEY=your_key_here
npm uninstall -g @lukaloehr/context-engine
npm install -g .
context

# Select Anthropic model
> model
# Choose Claude 3 Opus
```

## üìù Code Style Guide

### JavaScript/ES Modules

```javascript
// Use ES modules
import { something } from './module.js';
export { something };

// Prefer named exports
export function myFunction() {}
export class MyClass {}

// Async/await for promises
async function fetchData() {
  const result = await somePromise();
  return result;
}
```

### Naming Conventions

```javascript
// camelCase for variables and functions
const myVariable = 'value';
function myFunction() {}

// PascalCase for classes
class MyClass {}
class MySubAgent extends SubAgent {}

// UPPER_CASE for constants
const MAX_RETRIES = 3;
const API_BASE_URL = 'https://api.example.com';

// kebab-case for file names
my-module.js
my-subagent.js
```

### Documentation

```javascript
/**
 * Brief description of function
 * @param {string} param1 - Description of param1
 * @param {Object} param2 - Description of param2
 * @param {number} param2.value - Nested property
 * @returns {Promise<Object>} Description of return value
 */
async function myFunction(param1, param2) {
  // Implementation
}
```

### Error Handling

```javascript
// Return error objects in tools
return {
  success: false,
  error: 'Clear error message for users'
};

// Throw for unexpected errors
if (!criticalData) {
  throw new Error('Critical data missing');
}

// Use try-catch for async operations
try {
  const result = await riskyOperation();
} catch (error) {
  console.error('Operation failed:', error.message);
  throw error;
}
```

## üß™ Testing Guidelines

### Unit Tests

```javascript
// tests/tools/my-tool.test.js
import { toolRegistry } from '../../src/tools/index.js';

describe('myTool', () => {
  test('handles valid input', async () => {
    const tool = toolRegistry.tools.get('myTool');
    const result = await tool.handler(
      { param: 'value' },
      { projectContext: [] }
    );
    
    expect(result.success).toBe(true);
  });

  test('handles invalid input', async () => {
    const tool = toolRegistry.tools.get('myTool');
    const result = await tool.handler(
      {},
      { projectContext: [] }
    );
    
    expect(result.success).toBe(false);
    expect(result.error).toBeDefined();
  });
});
```

### Integration Tests

```javascript
// tests/integration/subagent-execution.test.js
import { getSubAgent } from '../../src/sub-agents/index.js';

describe('SubAgent execution', () => {
  test('creates file successfully', async () => {
    const agent = getSubAgent('agents-md');
    const result = await agent.execute(
      {},
      mockProjectContext,
      mockModelInfo,
      mockApiKey,
      mockProvider
    );
    
    expect(result.success).toBe(true);
    expect(fs.existsSync('AGENTS.md')).toBe(true);
  });
});
```

## üìö Documentation Requirements

### For Tools
- Purpose and use cases
- Parameters and types
- Return value structure
- Example usage
- Access control reasoning

### For SubAgents
- What documentation it generates
- System prompt explanation
- Example output
- Use cases

### For Providers
- Supported models
- API requirements
- Rate limits
- Special features

### README Updates

When adding major features, update:
- Main README.md
- Module-specific README
- ARCHITECTURE.md (if applicable)
- AGENTS.md (via `context create agents.md`)

## üîÑ Pull Request Process

### 1. Fork and Branch

```bash
git clone https://github.com/YOUR_USERNAME/context-engine.git
cd context-engine
git checkout -b feature/my-awesome-feature
```

### 2. Make Changes

- Follow code style guide
- Add tests
- Update documentation
- Test locally

### 3. Commit

```bash
git add .
git commit -m "feat: add awesome feature

- Detailed description
- What changed
- Why it changed"
```

Use conventional commits:
- `feat:` New feature
- `fix:` Bug fix
- `docs:` Documentation
- `refactor:` Code refactor
- `test:` Tests
- `chore:` Maintenance

### 4. Push and PR

```bash
git push origin feature/my-awesome-feature
```

Create PR on GitHub with:
- Clear title
- Description of changes
- Testing done
- Screenshots (if UI changes)

### 5. Code Review

- Address feedback promptly
- Update PR as requested
- Keep discussion focused

### 6. Merge

Once approved:
- Squash commits if needed
- Maintainer will merge
- Delete branch after merge

## üéØ Contribution Ideas

### Easy (Good First Issues)
- Add new tool for code analysis
- Create subagent for new doc type
- Improve error messages
- Add examples to documentation

### Medium
- Add new AI provider
- Implement tool chaining
- Add caching layer
- Improve token management

### Hard
- Provider registry system
- Plugin architecture
- API server mode
- Distributed subagents

## ‚ùì Questions?

- Open an issue for questions
- Join discussions on GitHub
- Check existing issues and PRs
- Read ARCHITECTURE.md for deep dive

## üìÑ License

By contributing, you agree that your contributions will be licensed under the MIT License.

---

*Thank you for contributing to Context Engine! üéâ*

